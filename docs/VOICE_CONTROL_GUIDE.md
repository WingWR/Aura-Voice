# 语音控制功能使用指南

## 🎤 功能概述

语音控制功能整合了讯飞语音识别API和智能指令匹配系统，让用户可以通过自然语言控制智能家居设备。

### 核心特性

- 🎯 **智能指令匹配**：基于关键词和语义分析的多层匹配算法
- 🔄 **多命令支持**：支持一次语音输入控制多个设备
- 🧠 **容错能力**：支持词序变化、同义词、模糊匹配
- 📱 **实时反馈**：显示识别结果、匹配度和执行状态
- 🔗 **设备集成**：直接控制HC-05蓝牙设备

## 🚀 使用方法

### 1. 基本操作

#### 在设备管理页面：
1. 点击右下角的**语音控制按钮**（麦克风图标）
2. 说出控制指令，如"打开客厅的灯"
3. 等待识别和执行结果

#### 在语音页面：
- 除了原有的录音功能，还增加了智能语音控制
- 两个功能可以独立使用

### 2. 支持的语音指令

#### 客厅设备：
```
"打开客厅的灯"          → 信号: 1
"加大客厅的灯光"        → 信号: 2  
"降低客厅的灯光"        → 信号: 3
"转换客厅的灯光颜色"    → 信号: 4
"关闭客厅的灯光"        → 信号: 5
```

#### 卧室设备：
```
"打开卧室的灯"          → 信号: 6
"打开卧室的氛围灯"      → 信号: 7
"关闭卧室的灯"          → 信号: 8
```

#### 其他设备：
```
"打开空调"              → 信号: 9
"关闭空调"              → 信号: a
"打开音响，放一首歌"    → 信号: b
"关闭音响"              → 信号: c
```

### 3. 灵活表达方式

系统支持多种表达方式：

#### 词序变化：
- ✅ "打开客厅的灯" 
- ✅ "客厅的灯打开"
- ✅ "客厅灯打开"

#### 同义词：
- ✅ "打开" = "开启" = "启动"
- ✅ "关闭" = "关掉" = "停止"
- ✅ "灯" = "灯光"

#### 简化表达：
- ✅ "开客厅灯"
- ✅ "关卧室灯"
- ✅ "播放音乐"

## 🔧 技术实现

### 1. 语音识别
- **引擎**：讯飞语音识别API (H5版本)
- **采样率**：16kHz
- **格式**：PCM 16位
- **语言**：中文普通话

### 2. 指令匹配算法

#### 三层匹配机制：

1. **精确匹配**：完全相同的指令
2. **灵活匹配**：基于关键词权重的语义匹配
3. **模糊匹配**：基于编辑距离的相似度匹配

#### 关键词权重：
- **位置词**（客厅、卧室）：权重 3
- **设备词**（灯、空调）：权重 2  
- **动作词**（打开、关闭）：权重 2
- **其他词**（颜色、音乐）：权重 1

### 3. 匹配得分计算
```javascript
得分 = 匹配的关键词权重总和 / 命令中关键词权重总和
```

只有得分 > 0.3 的匹配才会被接受。

## 📊 状态指示

### 语音控制按钮状态：
- **灰色**：待机状态
- **红色+脉冲**：正在录音
- **黄色+旋转**：处理中
- **绿色**：执行成功

### 识别结果显示：
- 显示原始识别文本
- 显示匹配的指令
- 显示匹配得分

## 🧪 测试功能

### 使用测试页面：
打开 `test-voice-control.html` 进行功能测试：

1. **预设测试**：点击预设指令测试各种匹配场景
2. **自定义测试**：输入任意文本测试匹配效果
3. **查看所有指令**：显示完整的指令映射表
4. **实时日志**：查看详细的匹配过程

### 测试用例：
```
✅ "打开客厅的灯"     - 精确匹配
✅ "客厅灯打开"       - 词序变化
✅ "开启客厅灯光"     - 同义词
✅ "关掉卧室的灯"     - 动作词变化
✅ "调节客厅灯光亮度" - 复杂指令
❌ "关闭所有设备"     - 无匹配指令
```

## 🔍 故障排除

### 常见问题：

#### 1. 语音识别失败
```
原因：麦克风权限、网络问题、API配置
解决：检查浏览器权限、网络连接、API密钥
```

#### 2. 指令无法匹配
```
原因：表达方式不在支持范围内
解决：参考支持的指令列表，使用标准表达
```

#### 3. 设备控制失败
```
原因：蓝牙未连接、HC-05离线
解决：检查蓝牙连接状态，确保HC-05正常工作
```

#### 4. 识别准确率低
```
原因：环境噪音、发音不清晰
解决：在安静环境下清晰发音，靠近麦克风
```

### 调试技巧：

#### 查看控制台日志：
```javascript
// 语音识别过程
[语音控制] 识别结果: "打开客厅的灯"
[语音控制] 开始匹配语音指令...
[语音指令测试] 输入: "打开客厅的灯"
[语音指令测试] 找到 1 个匹配结果:
  1. 信号: 1, 命令: "打开客厅的灯"
     匹配类型: exact, 得分: 1.000

// 设备控制过程  
[语音控制] 指令匹配成功: {signal: "1", matchedCommand: "打开客厅的灯", ...}
[语音控制] 执行设备控制: 1 - 打开客厅的灯
[调试信息] 正在执行操作: 打开客厅的灯
[调试信息] 发送指令: 1
```

## 📈 性能优化

### 1. 识别速度优化
- 使用16kHz采样率平衡质量和速度
- 实时音频处理减少延迟
- WebSocket连接复用

### 2. 匹配算法优化
- 预处理文本减少计算量
- 权重匹配优先于模糊匹配
- 缓存常用匹配结果

### 3. 用户体验优化
- 视觉反馈显示当前状态
- 触觉反馈增强交互感受
- 错误提示帮助用户纠正

## 🔮 扩展功能

### 计划中的功能：
- 🎯 **场景控制**：支持"睡眠模式"、"会客模式"等场景指令
- 🔄 **连续对话**：支持多轮对话和上下文理解
- 🌐 **多语言**：支持英语、方言等多种语言
- 🤖 **AI助手**：集成ChatGPT等AI模型进行智能对话

### 自定义指令：
可以通过修改 `stores/instructionMap.json` 添加新的指令：

```json
{
  "d": "调节客厅温度",
  "e": "播放轻音乐",
  "f": "设置睡眠模式"
}
```

---

**最后更新：** 2024年12月  
**版本：** 1.0
