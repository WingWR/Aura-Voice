# 语音控制与设备状态同步测试指南

## 🎯 测试目标

验证语音控制指令能够正确同步到设备管理界面的状态显示。

## 🔧 修改内容总结

### 1. 设备初始状态修改
- **文件**: `stores/devices.js`
- **修改**: 将所有设备的默认 `active` 状态改为 `false`
- **目的**: 确保初始状态一致，便于测试状态变化

### 2. 设备状态同步机制
- **文件**: `utils/deviceControl.js`
- **新增**: `setDeviceStoreRef()` 函数和 `deviceStoreRef` 变量
- **修改**: 所有设备控制函数现在会同时更新本地状态和前端界面状态

### 3. 设备存储增强
- **文件**: `stores/devices.js`
- **新增**: `updateDeviceStateFromVoice()` 方法
- **功能**: 专门用于语音控制更新设备状态

### 4. 语音控制优化
- **文件**: `components/VoiceControl.vue` 和 `pages/tabbar/voice/voice.vue`
- **修改**: `executeDeviceControl()` 函数现在使用设备控制函数而不是直接发送蓝牙指令
- **优势**: 确保状态同步到界面

### 5. 设备管理页面初始化
- **文件**: `pages/tabbar/manage/manage.vue`
- **新增**: 在组件挂载时设置设备存储引用
- **功能**: 建立语音控制与界面状态的连接

## 🧪 测试步骤

### 步骤1: 检查初始状态
1. 打开设备管理页面
2. 确认所有设备显示为关闭状态（灰色图标，无活动指示器）

### 步骤2: 测试语音控制同步
1. 在设备管理页面，点击右下角的语音控制按钮
2. 说出指令："打开客厅的灯"
3. 观察客厅灯设备卡片是否立即变为激活状态（彩色图标，显示活动指示器）

### 步骤3: 测试多种设备
依次测试以下语音指令，观察对应设备状态变化：

| 语音指令 | 对应设备 | 预期变化 |
|---------|---------|---------|
| "打开客厅的灯" | 客厅灯 | 激活状态，显示亮度 |
| "加大客厅的灯光" | 客厅灯 | 亮度增加 |
| "转换客厅的灯光颜色" | 客厅灯 | 颜色变化 |
| "打开卧室的灯" | 卧室主灯 | 激活状态 |
| "打开卧室的氛围灯" | 卧室氛围灯 | 激活状态，显示颜色 |
| "打开空调" | 空调 | 激活状态，显示温度 |
| "打开音响" | 音响 | 激活状态，显示音量 |

### 步骤4: 测试关闭指令
1. 说出关闭指令："关闭客厅的灯光"
2. 观察客厅灯是否变为非激活状态

### 步骤5: 测试手动控制
1. 手动点击设备卡片的开关按钮
2. 确认手动控制仍然正常工作
3. 验证手动控制与语音控制状态保持一致

## ✅ 预期结果

1. **状态同步**: 语音指令执行后，设备管理界面立即反映状态变化
2. **视觉反馈**: 设备卡片颜色、图标、活动指示器正确显示
3. **状态一致性**: 语音控制和手动控制的状态保持同步
4. **错误处理**: 无效指令不会影响界面状态

## 🐛 故障排除

### 问题1: 语音指令执行但界面无变化
**可能原因**: 设备存储引用未正确设置
**解决方案**: 检查 `manage.vue` 中的 `setDeviceStoreRef(deviceStore)` 调用

### 问题2: 部分设备状态不同步
**可能原因**: 设备名称映射不匹配
**解决方案**: 检查 `deviceControl.js` 中的设备名称与 `stores/devices.js` 中的名称是否一致

### 问题3: 蓝牙指令发送失败
**可能原因**: 蓝牙连接问题
**解决方案**: 检查蓝牙连接状态，确保设备已配对

## 📝 注意事项

1. 确保在真实设备上测试，模拟器可能无法完全模拟蓝牙功能
2. 测试前确保已连接蓝牙设备
3. 观察控制台日志，确认指令执行流程
4. 如果发现问题，请检查相关文件的修改是否正确应用

## 🔄 回滚方案

如果测试发现问题，可以通过以下步骤回滚：
1. 恢复 `stores/devices.js` 中的原始 `active` 状态
2. 移除 `utils/deviceControl.js` 中的设备存储引用相关代码
3. 恢复语音控制组件中的原始 `executeDeviceControl` 函数
