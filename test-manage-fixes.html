<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>设备管理修复测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-button {
            background: #00bfa5;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        .test-button:hover {
            background: #00a693;
        }
        .scene-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            min-width: 120px;
        }
        .scene-button:hover {
            background: #2563eb;
        }
        .scene-button.active {
            background: #10b981;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #00bfa5;
        }
        .device-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #e8f5e8;
            border-radius: 4px;
            border-left: 3px solid #4caf50;
        }
        .device-name {
            font-weight: bold;
            color: #333;
        }
        .device-state {
            font-size: 14px;
            color: #666;
        }
        .floating-ball {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            background: #00bfa5;
            box-shadow: 0 4px 12px rgba(0, 191, 165, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .floating-ball:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 191, 165, 0.4);
        }
        .floating-ball.listening {
            background: #ff5722;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🏠 设备管理修复测试</h1>
        <p>测试语音识别按钮和场景模式的蓝牙信号发送功能</p>

        <div class="test-section">
            <h3>🎤 语音识别测试</h3>
            <p>测试悬浮球语音识别功能（模拟）</p>
            <button class="test-button" onclick="testVoiceRecognition()">模拟语音识别</button>
            <div id="voiceResult"></div>
        </div>

        <div class="test-section">
            <h3>🌟 场景模式测试</h3>
            <p>测试场景激活时的蓝牙信号发送</p>
            <div class="scene-buttons">
                <button class="scene-button" onclick="testScene('morning')">早晨模式</button>
                <button class="scene-button" onclick="testScene('sleep')">睡眠模式</button>
                <button class="scene-button" onclick="testScene('movie')">影院模式</button>
                <button class="scene-button" onclick="testScene('guest')">会客模式</button>
            </div>
            <div id="sceneResult"></div>
        </div>

        <div class="test-section">
            <h3>📊 设备状态模拟</h3>
            <div id="deviceStatus">
                <div class="device-status">
                    <div class="device-name">客厅灯</div>
                    <div class="device-state" id="device-1">关闭</div>
                </div>
                <div class="device-status">
                    <div class="device-name">卧室主灯</div>
                    <div class="device-state" id="device-2">关闭</div>
                </div>
                <div class="device-status">
                    <div class="device-name">卧室氛围灯</div>
                    <div class="device-state" id="device-3">关闭</div>
                </div>
                <div class="device-status">
                    <div class="device-name">空调</div>
                    <div class="device-state" id="device-4">关闭</div>
                </div>
                <div class="device-status">
                    <div class="device-name">音响</div>
                    <div class="device-state" id="device-7">关闭</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模拟悬浮球 -->
    <div class="floating-ball" id="floatingBall" onclick="toggleVoiceRecognition()">
        🎤
    </div>

    <script>
        // 模拟设备状态
        const deviceStates = {
            1: false, // 客厅灯
            2: false, // 卧室主灯
            3: false, // 卧室氛围灯
            4: false, // 空调
            7: false  // 音响
        };

        // 场景配置
        const scenes = {
            morning: {
                name: '早晨模式',
                devices: [
                    { id: 1, active: true },  // 客厅灯
                    { id: 2, active: true },  // 卧室主灯
                    { id: 4, active: true },  // 空调
                    { id: 7, active: true }   // 音响
                ]
            },
            sleep: {
                name: '睡眠模式',
                devices: [
                    { id: 1, active: false }, // 客厅灯
                    { id: 2, active: false }, // 卧室主灯
                    { id: 3, active: true },  // 卧室氛围灯
                    { id: 4, active: false }, // 空调
                    { id: 7, active: false }  // 音响
                ]
            },
            movie: {
                name: '影院模式',
                devices: [
                    { id: 1, active: true },  // 客厅灯
                    { id: 7, active: true }   // 音响
                ]
            },
            guest: {
                name: '会客模式',
                devices: [
                    { id: 1, active: true },  // 客厅灯
                    { id: 4, active: true },  // 空调
                    { id: 7, active: true }   // 音响
                ]
            }
        };

        let isListening = false;

        // 更新设备状态显示
        function updateDeviceDisplay() {
            Object.keys(deviceStates).forEach(id => {
                const element = document.getElementById(`device-${id}`);
                if (element) {
                    element.textContent = deviceStates[id] ? '开启' : '关闭';
                    element.style.color = deviceStates[id] ? '#10b981' : '#6b7280';
                }
            });
        }

        // 模拟蓝牙信号发送
        function sendBluetoothSignal(signal, deviceName) {
            console.log(`[蓝牙信号] 发送信号: ${signal} - ${deviceName}`);
            return new Promise(resolve => {
                setTimeout(() => {
                    console.log(`[蓝牙信号] 信号发送成功: ${signal}`);
                    resolve(true);
                }, 100);
            });
        }

        // 测试语音识别
        async function testVoiceRecognition() {
            const testCommands = [
                '打开客厅的灯',
                '关闭空调',
                '打开音响',
                '关闭所有灯'
            ];
            
            const randomCommand = testCommands[Math.floor(Math.random() * testCommands.length)];
            
            document.getElementById('voiceResult').innerHTML = `
                <div class="result">
                    <strong>模拟语音识别:</strong> "${randomCommand}"<br>
                    <strong>处理结果:</strong> 已发送对应蓝牙信号<br>
                    <strong>时间:</strong> ${new Date().toLocaleTimeString()}
                </div>
            `;

            // 模拟设备控制
            if (randomCommand.includes('客厅') && randomCommand.includes('灯')) {
                deviceStates[1] = randomCommand.includes('打开');
                await sendBluetoothSignal('1', '客厅灯');
            } else if (randomCommand.includes('空调')) {
                deviceStates[4] = randomCommand.includes('打开');
                await sendBluetoothSignal('9', '空调');
            } else if (randomCommand.includes('音响')) {
                deviceStates[7] = randomCommand.includes('打开');
                await sendBluetoothSignal('b', '音响');
            }

            updateDeviceDisplay();
        }

        // 测试场景模式
        async function testScene(sceneId) {
            const scene = scenes[sceneId];
            if (!scene) return;

            // 重置所有按钮状态
            document.querySelectorAll('.scene-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // 激活当前按钮
            event.target.classList.add('active');

            console.log(`[场景控制] 激活场景: ${scene.name}`);

            let resultHtml = `
                <div class="result">
                    <strong>激活场景:</strong> ${scene.name}<br>
                    <strong>控制设备:</strong><br>
            `;

            // 执行场景中的设备控制
            for (const device of scene.devices) {
                const deviceName = getDeviceName(device.id);
                const action = device.active ? '开启' : '关闭';
                const signal = getDeviceSignal(device.id, device.active);
                
                console.log(`[场景控制] ${deviceName} -> ${action}`);
                
                // 发送蓝牙信号
                await sendBluetoothSignal(signal, deviceName);
                
                // 更新设备状态
                deviceStates[device.id] = device.active;
                
                resultHtml += `&nbsp;&nbsp;• ${deviceName}: ${action}<br>`;
                
                // 设备间延迟
                await new Promise(resolve => setTimeout(resolve, 200));
            }

            resultHtml += `<strong>执行时间:</strong> ${new Date().toLocaleTimeString()}</div>`;
            document.getElementById('sceneResult').innerHTML = resultHtml;

            updateDeviceDisplay();
        }

        // 获取设备名称
        function getDeviceName(id) {
            const names = {
                1: '客厅灯',
                2: '卧室主灯',
                3: '卧室氛围灯',
                4: '空调',
                7: '音响'
            };
            return names[id] || '未知设备';
        }

        // 获取设备信号
        function getDeviceSignal(id, active) {
            const signals = {
                1: active ? '1' : '5',  // 客厅灯
                2: active ? '6' : '8',  // 卧室主灯
                3: active ? '7' : 'd',  // 卧室氛围灯
                4: active ? '9' : 'a',  // 空调
                7: active ? 'b' : 'c'   // 音响
            };
            return signals[id] || '0';
        }

        // 切换语音识别状态
        function toggleVoiceRecognition() {
            const ball = document.getElementById('floatingBall');
            isListening = !isListening;
            
            if (isListening) {
                ball.classList.add('listening');
                ball.textContent = '🔴';
                setTimeout(() => {
                    testVoiceRecognition();
                    ball.classList.remove('listening');
                    ball.textContent = '🎤';
                    isListening = false;
                }, 2000);
            }
        }

        // 初始化显示
        updateDeviceDisplay();
    </script>
</body>
</html>
