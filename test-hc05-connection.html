<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HC-05 蓝牙模块连接测试</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 40px;
            backdrop-filter: blur(10px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            margin-bottom: 40px;
            opacity: 0.8;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .section h3 {
            margin-top: 0;
            color: #4ecdc4;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .status-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #dc3545;
            animation: pulse 2s infinite;
        }
        
        .status-dot.success {
            background: #28a745;
        }
        
        .status-dot.warning {
            background: #ffc107;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #dc3545, #fd7e14);
        }
        
        .log-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-entry.info {
            color: #17a2b8;
        }
        
        .log-entry.success {
            color: #28a745;
        }
        
        .log-entry.error {
            color: #dc3545;
        }
        
        .log-entry.warning {
            color: #ffc107;
        }
        
        .instructions {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .instructions h4 {
            color: #ffc107;
            margin-top: 0;
        }
        
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .command-test {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        
        .command-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            padding: 8px 12px;
            color: white;
            font-family: 'Courier New', monospace;
        }
        
        .command-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">🔵 HC-05 蓝牙模块测试</h1>
        <p class="subtitle">专门用于测试HC-05蓝牙模块的连接和通信</p>
        
        <div class="instructions">
            <h4>📋 连接步骤</h4>
            <ol>
                <li><strong>配对HC-05：</strong> 在Windows蓝牙设置中搜索并配对HC-05设备（默认PIN: 1234或0000）</li>
                <li><strong>确认COM口：</strong> 在设备管理器中查看HC-05分配的COM端口号</li>
                <li><strong>使用Chrome：</strong> 确保使用Chrome 89+或Edge 89+浏览器</li>
                <li><strong>点击连接：</strong> 点击下方"连接HC-05"按钮，选择对应的串口</li>
                <li><strong>测试通信：</strong> 发送测试指令验证连接</li>
            </ol>
        </div>
        
        <div class="section">
            <h3>🔍 系统检测</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-dot" :class="{ success: hasSerial }"></div>
                    <span>Web Serial API: {{ hasSerial ? '支持' : '不支持' }}</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" :class="{ success: hasBluetooth }"></div>
                    <span>Web Bluetooth API: {{ hasBluetooth ? '支持' : '不支持' }}</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" :class="{ success: isConnected, warning: isConnecting }"></div>
                    <span>连接状态: {{ connectionStatus }}</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" :class="{ success: connectionType !== 'none' }"></div>
                    <span>连接方式: {{ connectionTypeText }}</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>🔧 连接控制</h3>
            <div class="button-group">
                <button class="btn" :class="{ success: isConnected }" @click="connectDevice" :disabled="isConnecting">
                    {{ isConnecting ? '连接中...' : (isConnected ? '已连接' : '连接HC-05') }}
                </button>
                <button class="btn danger" @click="disconnectDevice" :disabled="!isConnected">
                    断开连接
                </button>
                <button class="btn" @click="getConnectionInfo">
                    获取连接信息
                </button>
                <button class="btn" @click="clearLog">
                    清空日志
                </button>
            </div>
        </div>
        
        <div class="section">
            <h3>📡 指令测试</h3>
            <div class="button-group">
                <button class="btn" @click="sendTestCommand('1')" :disabled="!isConnected">测试指令: 1</button>
                <button class="btn" @click="sendTestCommand('2')" :disabled="!isConnected">测试指令: 2</button>
                <button class="btn" @click="sendTestCommand('3')" :disabled="!isConnected">测试指令: 3</button>
                <button class="btn" @click="sendTestCommand('AT')" :disabled="!isConnected">AT指令测试</button>
            </div>
            
            <div class="command-test">
                <input 
                    type="text" 
                    class="command-input" 
                    v-model="customCommand" 
                    placeholder="输入自定义指令..."
                    @keyup.enter="sendCustomCommand"
                >
                <button class="btn" @click="sendCustomCommand" :disabled="!isConnected || !customCommand">
                    发送
                </button>
            </div>
        </div>
        
        <div class="section">
            <h3>📝 操作日志</h3>
            <div class="log-container" ref="logContainer">
                <div v-for="(log, index) in logs" :key="index" class="log-entry" :class="log.type">
                    [{{ log.time }}] {{ log.message }}
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
        const { createApp, ref, computed, nextTick, onMounted } = Vue;
        
        createApp({
            setup() {
                const logs = ref([]);
                const logContainer = ref(null);
                const isConnecting = ref(false);
                const customCommand = ref('');
                
                // 模拟蓝牙控制对象
                const bluetoothControl = {
                    isConnected: ref(false),
                    connectionType: ref('none'),
                    serialPort: ref(null),
                    
                    async connectBluetooth() {
                        if (!navigator.serial) {
                            throw new Error('浏览器不支持Web Serial API');
                        }
                        
                        const port = await navigator.serial.requestPort();
                        await port.open({
                            baudRate: 9600,
                            dataBits: 8,
                            stopBits: 1,
                            parity: 'none'
                        });
                        
                        this.serialPort.value = port;
                        this.isConnected.value = true;
                        this.connectionType.value = 'serial';
                        return true;
                    },
                    
                    async disconnectBluetooth() {
                        if (this.serialPort.value) {
                            await this.serialPort.value.close();
                            this.serialPort.value = null;
                        }
                        this.isConnected.value = false;
                        this.connectionType.value = 'none';
                    },
                    
                    async sendCommand(command) {
                        if (!this.isConnected.value || !this.serialPort.value) {
                            throw new Error('设备未连接');
                        }
                        
                        const writer = this.serialPort.value.writable.getWriter();
                        const encoder = new TextEncoder();
                        const data = encoder.encode(command + '\n');
                        
                        await writer.write(data);
                        writer.releaseLock();
                        return true;
                    },
                    
                    getConnectionInfo() {
                        return {
                            isConnected: this.isConnected.value,
                            connectionType: this.connectionType.value,
                            hasSerial: !!navigator.serial,
                            hasBluetooth: !!navigator.bluetooth
                        };
                    }
                };
                
                const hasSerial = computed(() => !!navigator.serial);
                const hasBluetooth = computed(() => !!navigator.bluetooth);
                const isConnected = computed(() => bluetoothControl.isConnected.value);
                const connectionType = computed(() => bluetoothControl.connectionType.value);
                
                const connectionStatus = computed(() => {
                    if (isConnecting.value) return '连接中...';
                    if (isConnected.value) return '已连接';
                    return '未连接';
                });
                
                const connectionTypeText = computed(() => {
                    switch (connectionType.value) {
                        case 'serial': return '串口连接';
                        case 'web-bluetooth': return '蓝牙连接';
                        default: return '无连接';
                    }
                });
                
                const addLog = (message, type = 'info') => {
                    const time = new Date().toLocaleTimeString();
                    logs.value.push({ time, message, type });
                    nextTick(() => {
                        if (logContainer.value) {
                            logContainer.value.scrollTop = logContainer.value.scrollHeight;
                        }
                    });
                };
                
                const connectDevice = async () => {
                    if (isConnecting.value || isConnected.value) return;
                    
                    isConnecting.value = true;
                    addLog('开始连接HC-05蓝牙模块...', 'info');
                    
                    try {
                        await bluetoothControl.connectBluetooth();
                        addLog('✅ HC-05连接成功！', 'success');
                        addLog('连接方式: 串口通信', 'info');
                    } catch (error) {
                        addLog('❌ 连接失败: ' + error.message, 'error');
                        if (error.message.includes('No port selected')) {
                            addLog('💡 提示: 请在弹出的对话框中选择HC-05对应的COM端口', 'warning');
                        }
                    } finally {
                        isConnecting.value = false;
                    }
                };
                
                const disconnectDevice = async () => {
                    try {
                        await bluetoothControl.disconnectBluetooth();
                        addLog('🔌 设备已断开连接', 'info');
                    } catch (error) {
                        addLog('❌ 断开连接失败: ' + error.message, 'error');
                    }
                };
                
                const sendTestCommand = async (command) => {
                    try {
                        addLog(`📤 发送测试指令: ${command}`, 'info');
                        await bluetoothControl.sendCommand(command);
                        addLog(`✅ 指令发送成功: ${command}`, 'success');
                    } catch (error) {
                        addLog(`❌ 指令发送失败: ${error.message}`, 'error');
                    }
                };
                
                const sendCustomCommand = async () => {
                    if (!customCommand.value.trim()) return;
                    
                    try {
                        const cmd = customCommand.value.trim();
                        addLog(`📤 发送自定义指令: ${cmd}`, 'info');
                        await bluetoothControl.sendCommand(cmd);
                        addLog(`✅ 指令发送成功: ${cmd}`, 'success');
                        customCommand.value = '';
                    } catch (error) {
                        addLog(`❌ 指令发送失败: ${error.message}`, 'error');
                    }
                };
                
                const getConnectionInfo = () => {
                    const info = bluetoothControl.getConnectionInfo();
                    addLog('📊 连接信息:', 'info');
                    addLog(`  - 连接状态: ${info.isConnected ? '已连接' : '未连接'}`, 'info');
                    addLog(`  - 连接方式: ${info.connectionType}`, 'info');
                    addLog(`  - Web Serial支持: ${info.hasSerial ? '是' : '否'}`, 'info');
                    addLog(`  - Web Bluetooth支持: ${info.hasBluetooth ? '是' : '否'}`, 'info');
                };
                
                const clearLog = () => {
                    logs.value = [];
                };
                
                onMounted(() => {
                    addLog('🚀 HC-05测试页面已加载', 'success');
                    addLog('💡 请确保HC-05已在Windows中配对成功', 'warning');
                    getConnectionInfo();
                });
                
                return {
                    logs,
                    logContainer,
                    isConnecting,
                    customCommand,
                    hasSerial,
                    hasBluetooth,
                    isConnected,
                    connectionType,
                    connectionStatus,
                    connectionTypeText,
                    connectDevice,
                    disconnectDevice,
                    sendTestCommand,
                    sendCustomCommand,
                    getConnectionInfo,
                    clearLog
                };
            }
        }).mount('body');
    </script>
</body>
</html>
