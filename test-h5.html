<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>讯飞语音识别 H5 测试</title>
    <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            background-color: #00bfa5;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }
        .button:hover {
            background-color: #00a693;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }
        .status.idle { background-color: #e3f2fd; color: #1976d2; }
        .status.ready { background-color: #e8f5e8; color: #388e3c; }
        .status.recording { background-color: #fff3e0; color: #f57c00; }
        .status.processing { background-color: #fce4ec; color: #c2185b; }
        .result {
            margin: 20px 0;
            padding: 15px;
            background-color: #f9f9f9;
            border-left: 4px solid #00bfa5;
            min-height: 50px;
        }
        .log {
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>讯飞语音识别 H5 测试</h1>
        
        <div class="status idle" id="status">状态: 空闲</div>
        
        <button class="button" id="startBtn" onclick="startRecording()">开始录音</button>
        <button class="button" id="stopBtn" onclick="stopRecording()" disabled>停止录音</button>
        
        <div class="result">
            <h3>识别结果:</h3>
            <div id="result">等待识别...</div>
        </div>
        
        <div class="log" id="log">日志输出:\n</div>
    </div>

    <script>
        // 配置信息 - 请填入你的真实API密钥
        const config = {
            APPID: 'b2130caa',
            API_KEY: 'b2db6325b4fc4abf8f4f240520040f6c',
            API_SECRET: 'NmIxZDcxODgwNjIyNWU1NGIxOTRmZjc1',
            WS_URL: 'wss://iat-api.xfyun.cn/v2/iat'
        }

        let speechRecognizer = null

        // 简化版H5语音识别器
        class SimpleH5SpeechRecognizer {
            constructor() {
                this.ws = null
                this.status = 'idle'
                this.result = ''
                this.frameStatus = 0
                this.iatResult = []
                this.audioContext = null
                this.stream = null
                this.processor = null
                this.source = null
            }

            log(message) {
                const logElement = document.getElementById('log')
                const timestamp = new Date().toLocaleTimeString()
                logElement.textContent += `[${timestamp}] ${message}\n`
                logElement.scrollTop = logElement.scrollHeight
                console.log(message)
            }

            updateStatus(status) {
                this.status = status
                const statusElement = document.getElementById('status')
                statusElement.className = `status ${status}`
                
                const statusText = {
                    'idle': '空闲',
                    'ready': '准备就绪',
                    'recording': '录音中',
                    'processing': '处理中'
                }
                statusElement.textContent = `状态: ${statusText[status] || status}`
                
                // 更新按钮状态
                document.getElementById('startBtn').disabled = (status === 'recording' || status === 'processing')
                document.getElementById('stopBtn').disabled = (status !== 'recording')
            }

            getAuthStr(date) {
                const signatureOrigin = `host: iat-api.xfyun.cn\ndate: ${date}\nGET /v2/iat HTTP/1.1`
                const signatureSha = CryptoJS.HmacSHA256(signatureOrigin, config.API_SECRET)
                const signature = CryptoJS.enc.Base64.stringify(signatureSha)
                const authorizationOrigin = `api_key="${config.API_KEY}", algorithm="hmac-sha256", headers="host date request-line", signature="${signature}"`
                return CryptoJS.enc.Base64.stringify(CryptoJS.enc.Utf8.parse(authorizationOrigin))
            }

            async initWebSocket() {
                return new Promise((resolve, reject) => {
                    const date = new Date().toUTCString()
                    const authStr = this.getAuthStr(date)
                    const wssUrl = `${config.WS_URL}?authorization=${authStr}&date=${date}&host=iat-api.xfyun.cn`
                    
                    this.log('正在连接WebSocket...')
                    this.ws = new WebSocket(wssUrl)

                    this.ws.onopen = () => {
                        this.log('WebSocket连接成功')
                        this.updateStatus('ready')
                        resolve()
                    }

                    this.ws.onmessage = (event) => {
                        this.handleMessage(event.data)
                    }

                    this.ws.onerror = (error) => {
                        this.log('WebSocket错误: ' + error)
                        reject(error)
                    }

                    this.ws.onclose = () => {
                        this.log('WebSocket连接关闭')
                        this.updateStatus('idle')
                    }

                    setTimeout(() => {
                        if (this.status !== 'ready') {
                            reject(new Error('连接超时'))
                        }
                    }, 8000)
                })
            }

            handleMessage(data) {
                try {
                    const res = JSON.parse(data)
                    this.log(`收到消息: code=${res.code}, status=${res.data?.status}`)
                    
                    if (res.code !== 0) {
                        this.log(`识别错误: ${res.message}`)
                        return
                    }

                    this.iatResult[res.data.result.sn] = res.data.result
                    
                    let fullText = ""
                    this.iatResult.forEach(i => {
                        if (i != null) {
                            i.ws.forEach(j => {
                                j.cw.forEach(k => {
                                    fullText += k.w
                                })
                            })
                        }
                    })
                    
                    if (fullText.trim()) {
                        this.result = fullText
                        document.getElementById('result').textContent = fullText
                        this.log(`识别结果: ${fullText}`)
                    }

                    if (res.data.status === 2) {
                        this.log('识别完成')
                        this.ws.close()
                    }

                } catch (error) {
                    this.log('处理消息失败: ' + error)
                }
            }

            send(data) {
                if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
                    this.log('WebSocket未连接')
                    return
                }

                const frameDataSection = {
                    "status": this.frameStatus,
                    "format": "audio/L16;rate=16000",
                    "audio": data ? this.arrayBufferToBase64(data) : "",
                    "encoding": "raw"
                }

                let frame
                if (this.frameStatus === 0) {
                    frame = {
                        common: { app_id: config.APPID },
                        business: { language: "zh_cn", domain: "iat", accent: "mandarin", dwa: "wpgs" },
                        data: frameDataSection
                    }
                    this.frameStatus = 1
                } else {
                    frame = { data: frameDataSection }
                }

                this.log(`发送帧: status=${frameDataSection.status}, 数据大小=${data ? data.byteLength : 0}`)
                this.ws.send(JSON.stringify(frame))
            }

            arrayBufferToBase64(buffer) {
                let binary = ''
                const bytes = new Uint8Array(buffer)
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i])
                }
                return btoa(binary)
            }

            float32ToPCM16(float32Array) {
                const pcm16 = new Int16Array(float32Array.length)
                for (let i = 0; i < float32Array.length; i++) {
                    const sample = Math.max(-1, Math.min(1, float32Array[i]))
                    pcm16[i] = sample < 0 ? sample * 0x8000 : sample * 0x7FFF
                }
                return pcm16
            }

            async start() {
                try {
                    this.result = ''
                    this.iatResult = []
                    this.frameStatus = 0
                    document.getElementById('result').textContent = '识别中...'

                    await this.initWebSocket()

                    this.log('请求麦克风权限...')
                    this.stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: { sampleRate: 16000, channelCount: 1 } 
                    })

                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 })
                    this.source = this.audioContext.createMediaStreamSource(this.stream)
                    this.processor = this.audioContext.createScriptProcessor(1024, 1, 1)

                    this.processor.onaudioprocess = (event) => {
                        const inputData = event.inputBuffer.getChannelData(0)
                        const pcmData = this.float32ToPCM16(inputData)
                        this.send(pcmData.buffer)
                    }

                    this.source.connect(this.processor)
                    this.processor.connect(this.audioContext.destination)

                    this.updateStatus('recording')
                    this.log('开始录音')

                } catch (error) {
                    this.log('启动失败: ' + error.message)
                    this.updateStatus('idle')
                }
            }

            stop() {
                try {
                    this.log('停止录音')
                    this.updateStatus('processing')

                    if (this.processor) {
                        this.processor.disconnect()
                        this.processor = null
                    }
                    if (this.source) {
                        this.source.disconnect()
                        this.source = null
                    }
                    if (this.audioContext) {
                        this.audioContext.close()
                        this.audioContext = null
                    }
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop())
                        this.stream = null
                    }

                    // 发送结束帧
                    this.frameStatus = 2
                    this.send(null)

                } catch (error) {
                    this.log('停止失败: ' + error.message)
                    this.updateStatus('idle')
                }
            }
        }

        function startRecording() {
            if (!speechRecognizer) {
                speechRecognizer = new SimpleH5SpeechRecognizer()
            }
            speechRecognizer.start()
        }

        function stopRecording() {
            if (speechRecognizer) {
                speechRecognizer.stop()
            }
        }

        // 页面加载完成后的初始化
        window.onload = function() {
            const log = document.getElementById('log')
            log.textContent += '页面加载完成，请点击"开始录音"进行测试\n'
            log.textContent += '注意：需要HTTPS环境才能使用麦克风\n'
        }
    </script>
</body>
</html>
